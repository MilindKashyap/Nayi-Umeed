{% extends "base.html" %}
{% block title %}Marketplace - Nayi Umeed{% endblock %}
{% block content %}
<!-- Page Header -->
<div style="margin-bottom: var(--spacing-2xl);">
  <h1 style="margin-bottom: var(--spacing-sm);">Medical Device Marketplace</h1>
  <p style="color: var(--gray-600); font-size: var(--font-size-lg);">
    Browse certified and safe medical devices. All devices are inspected, repaired, and verified before listing.
  </p>
</div>

<!-- Filters -->
<div class="card" style="margin-bottom: var(--spacing-xl);">
  <h3 style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-lg);">Filter Devices</h3>
  <form id="filters" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4" style="gap: var(--spacing-md);">
    <div class="form-group" style="margin-bottom: 0;">
      <label for="filter-category" class="form-label">Category</label>
      <select id="filter-category" name="category" class="form-control">
        <option value="">All Categories</option>
        <option value="oxygen_concentrator">Oxygen Concentrator</option>
        <option value="ventilator">Ventilator</option>
        <option value="monitor">Patient Monitor</option>
        <option value="wheelchair">Wheelchair</option>
        <option value="other">Other</option>
      </select>
    </div>
    
    <div class="form-group" style="margin-bottom: 0;">
      <label for="filter-condition" class="form-label">Condition</label>
      <select id="filter-condition" name="condition" class="form-control">
        <option value="">All Conditions</option>
        <option value="new">New</option>
        <option value="good">Good</option>
        <option value="needs_repair">Needs Repair</option>
      </select>
    </div>
    
    <div class="form-group" style="margin-bottom: 0;">
      <label for="filter-price-min" class="form-label">Min Price (₹)</label>
      <input type="number" id="filter-price-min" name="price_min" step="0.01" min="0" class="form-control" placeholder="0">
    </div>
    
    <div class="form-group" style="margin-bottom: 0;">
      <label for="filter-price-max" class="form-label">Max Price (₹)</label>
      <input type="number" id="filter-price-max" name="price_max" step="0.01" min="0" class="form-control" placeholder="No limit">
    </div>
  </form>
</div>

<!-- Loading State -->
<div id="loading-indicator" style="text-align: center; padding: var(--spacing-3xl); display: none;">
  <p style="color: var(--gray-600);">Loading devices...</p>
</div>

<!-- Error State -->
<div id="error-message" class="alert alert-error" style="display: none;">
  Unable to load devices. Please check your connection and try again.
</div>

<!-- Device Grid -->
<div id="listing-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3" style="gap: var(--spacing-xl);">
  {% if listings %}
    {% for listing in listings %}
      <div class="card" style="padding: 0; overflow: hidden;">
        {% if listing.device.images.first %}
          <img src="{{ listing.device.images.first.image.url }}" alt="{{ listing.device.title }}" style="width: 100%; height: 200px; object-fit: cover; display: block;" loading="lazy">
        {% else %}
          <div style="width: 100%; height: 200px; background: var(--gray-100); display: flex; align-items: center; justify-content: center; color: var(--gray-400);">
            No Image
          </div>
        {% endif %}
        
        <div style="padding: var(--spacing-lg);">
          <h3 style="font-size: var(--font-size-xl); margin-bottom: var(--spacing-sm);">{{ listing.device.title }}</h3>
          
          <div style="margin-bottom: var(--spacing-md);">
            <span class="badge badge-primary" style="margin-right: var(--spacing-xs);">{{ listing.device.get_category_display }}</span>
            <span class="badge badge-success">{{ listing.device.get_condition_display }}</span>
          </div>
          
        <div style="margin-bottom: var(--spacing-md); display: flex; flex-wrap: wrap; gap: var(--spacing-xs);">
          {% if listing.is_certified %}
            <span class="badge badge-success">
              ✓ Certified & Safe
            </span>
          {% endif %}
          {% if listing.is_sold %}
            <span class="badge badge-secondary" style="background-color: var(--gray-600);">
              Sold
            </span>
          {% endif %}
        </div>
          
          <div style="margin-bottom: var(--spacing-lg);">
            <div style="font-size: var(--font-size-2xl); font-weight: 700; color: var(--secondary);">
              ₹{{ listing.price }}
            </div>
          </div>
          
          <a href="{% url 'marketplace:detail' listing.pk %}" class="btn btn-primary btn-full" style="text-decoration: none; text-align: center;">
            View Details
          </a>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div style="grid-column: 1 / -1;">
      <div class="card text-center" style="padding: var(--spacing-3xl);">
        <p style="font-size: var(--font-size-lg); color: var(--gray-600); margin-bottom: var(--spacing-sm);">
          No devices available at the moment.
        </p>
        <p style="color: var(--gray-500);">Check back later for new listings.</p>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('filters');
  const resultsContainer = document.getElementById('listing-results');
  const loadingIndicator = document.getElementById('loading-indicator');
  const errorMessage = document.getElementById('error-message');
  
  if (!form || !resultsContainer) return;
  
  function showLoading() {
    loadingIndicator.style.display = 'block';
    errorMessage.style.display = 'none';
    resultsContainer.style.opacity = '0.5';
  }
  
  function hideLoading() {
    loadingIndicator.style.display = 'none';
    resultsContainer.style.opacity = '1';
  }
  
  function showError() {
    loadingIndicator.style.display = 'none';
    errorMessage.style.display = 'block';
    resultsContainer.style.opacity = '1';
  }
  
  function runFilters() {
    if (!navigator.onLine) {
      showError();
      return;
    }
    
    showLoading();
    const params = new URLSearchParams(new FormData(form));
    
    fetch(`{% url 'marketplace:listings_api' %}?${params.toString()}`)
      .then(r => {
        if (!r.ok) throw new Error('Network error');
        return r.json();
      })
      .then(data => {
        hideLoading();
        resultsContainer.innerHTML = '';
        
        if (!data.results || data.results.length === 0) {
          resultsContainer.innerHTML = `
            <div style="grid-column: 1 / -1;">
              <div class="card text-center" style="padding: var(--spacing-3xl);">
                <p style="font-size: var(--font-size-lg); color: var(--gray-600); margin-bottom: var(--spacing-md);">
                  No devices match your filters.
                </p>
                <button onclick="document.getElementById('filters').reset(); runFilters();" class="btn btn-outline">
                  Clear Filters
                </button>
              </div>
            </div>
          `;
          return;
        }
        
        data.results.forEach(item => {
          const card = document.createElement('div');
          card.className = 'card';
          card.style.cssText = 'padding: 0; overflow: hidden;';
          card.innerHTML = `
            <div style="width: 100%; height: 200px; background: var(--gray-100); display: flex; align-items: center; justify-content: center; color: var(--gray-400);">
              Device Image
            </div>
            <div style="padding: var(--spacing-lg);">
              <h3 style="font-size: var(--font-size-xl); margin-bottom: var(--spacing-sm);">${escapeHtml(item.title)}</h3>
              <div style="margin-bottom: var(--spacing-md);">
                <span class="badge badge-primary" style="margin-right: var(--spacing-xs);">${escapeHtml(item.category)}</span>
                <span class="badge badge-success">${escapeHtml(item.condition)}</span>
              </div>
              ${item.certified ? '<div style="margin-bottom: var(--spacing-md);"><span class="badge badge-success">✓ Certified & Safe</span></div>' : ''}
              <div style="margin-bottom: var(--spacing-lg);">
                <div style="font-size: var(--font-size-2xl); font-weight: 700; color: var(--secondary);">₹${item.price}</div>
              </div>
              <a href="/marketplace/${item.id}/" class="btn btn-primary btn-full" style="text-decoration: none; text-align: center;">View Details</a>
            </div>
          `;
          resultsContainer.appendChild(card);
        });
      })
      .catch(err => {
        console.error('Filter error:', err);
        showError();
      });
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  form.addEventListener('change', runFilters);
  form.addEventListener('input', function(e) {
    if (e.target.type === 'number') {
      runFilters();
    }
  });
});
</script>
{% endblock %}
