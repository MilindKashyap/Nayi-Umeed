{% extends "base.html" %}
{% load cloudinary_tags %}
{% block title %}Marketplace - Nayi Umeed{% endblock %}
{% block content %}
<!-- Page Header -->
<div style="margin-bottom: var(--spacing-2xl);">
  <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: var(--spacing-lg);">
    <div>
      <h1 style="margin-bottom: var(--spacing-sm);">Medical Device Marketplace</h1>
      <p style="color: var(--gray-600); font-size: var(--font-size-lg);">
        Browse certified and safe medical devices. All devices are inspected, repaired, and verified before listing.
      </p>
    </div>
    <div style="color: var(--gray-600); font-size: var(--font-size-base); padding: var(--spacing-sm) var(--spacing-lg); background: var(--gray-50); border-radius: var(--radius-md);">
      <strong>{{ listings|length }}</strong> result{{ listings|length|pluralize }}
    </div>
  </div>
</div>

<!-- Filters -->
<div class="card" style="margin-bottom: var(--spacing-xl);">
  <h3 style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-lg);">Filter Devices</h3>
  <form id="filters" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4" style="gap: var(--spacing-md);">
    <div class="form-group" style="margin-bottom: 0;">
      <label for="filter-category" class="form-label">Category</label>
      <select id="filter-category" name="category" class="form-control">
        <option value="">All Categories</option>
        <option value="oxygen_concentrator">Oxygen Concentrator</option>
        <option value="ventilator">Ventilator</option>
        <option value="monitor">Patient Monitor</option>
        <option value="wheelchair">Wheelchair</option>
        <option value="other">Other</option>
      </select>
    </div>
    
    <div class="form-group" style="margin-bottom: 0;">
      <label for="filter-condition" class="form-label">Condition</label>
      <select id="filter-condition" name="condition" class="form-control">
        <option value="">All Conditions</option>
        <option value="new">New</option>
        <option value="good">Good</option>
        <option value="needs_repair">Needs Repair</option>
      </select>
    </div>
    
    <div class="form-group" style="margin-bottom: 0;">
      <label for="filter-price-min" class="form-label">Min Price (₹)</label>
      <input type="number" id="filter-price-min" name="price_min" step="0.01" min="0" class="form-control" placeholder="0">
    </div>
    
    <div class="form-group" style="margin-bottom: 0;">
      <label for="filter-price-max" class="form-label">Max Price (₹)</label>
      <input type="number" id="filter-price-max" name="price_max" step="0.01" min="0" class="form-control" placeholder="No limit">
    </div>
  </form>
</div>

<!-- Loading State -->
<div id="loading-indicator" style="text-align: center; padding: var(--spacing-3xl); display: none;">
  <p style="color: var(--gray-600);">Loading devices...</p>
</div>

<!-- Error State -->
<div id="error-message" class="alert alert-error" style="display: none;">
  Unable to load devices. Please check your connection and try again.
</div>

<!-- Device Grid -->
<div id="listing-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3" style="gap: var(--spacing-xl);">
  {% if listings %}
    {% for listing in listings %}
      <div class="card" style="padding: 0; overflow: hidden; position: relative; transition: all 0.3s ease;">
        <!-- Image Container with Shopping Cart Icon -->
        <div style="position: relative; width: 100%; height: 240px; overflow: hidden; background: var(--gray-100);">
          {% if listing.device.images.first %}
            <img src="{{ listing.device.images.first|cloudinary_url_by_device }}" 
                 alt="{{ listing.device.title }}" 
                 style="width: 100%; height: 100%; object-fit: cover; object-position: center; display: block; transition: transform 0.3s ease;" 
                 loading="lazy"
                 onmouseover="this.style.transform='scale(1.05)'"
                 onmouseout="this.style.transform='scale(1)'">
          {% else %}
            <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--gray-400); background: var(--gray-100);">
              <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
              </svg>
            </div>
          {% endif %}
          
          <!-- Shopping Cart Icon Overlay -->
          <div style="position: absolute; bottom: 12px; right: 12px; width: 40px; height: 40px; background: var(--error); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); transition: transform 0.2s ease;"
               onmouseover="this.style.transform='scale(1.1)'"
               onmouseout="this.style.transform='scale(1)'"
               onclick="window.location.href='{% url 'marketplace:detail' listing.pk %}'">
            <svg width="20" height="20" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.222M7.5 14.25l13.5-5.25M5.106 5.222L12.75 12.75m-7.644-7.5L12.75 12.75" />
            </svg>
          </div>
        </div>
        
        <!-- Card Content -->
        <div style="padding: var(--spacing-lg);">
          <!-- Title -->
          <h3 style="font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--spacing-sm); color: var(--gray-900); line-height: 1.3;">
            {{ listing.device.title }}
          </h3>
          
          <!-- Category Badge -->
          <div style="margin-bottom: var(--spacing-md);">
            <span class="badge badge-primary" style="font-size: var(--font-size-xs); text-transform: uppercase; letter-spacing: 0.5px;">
              {{ listing.device.get_category_display }}
            </span>
          </div>
          
          <!-- Rating/Status Row -->
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--spacing-sm);">
            <!-- Rating Stars (using condition as visual indicator) -->
            <div style="display: flex; gap: 2px;">
              {% if listing.is_certified %}
                {% for i in "12345" %}
                  <svg width="14" height="14" fill="{% if forloop.counter <= 4 %}var(--error){% else %}var(--gray-300){% endif %}" viewBox="0 0 24 24">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                  </svg>
                {% endfor %}
              {% else %}
                {% for i in "12345" %}
                  <svg width="14" height="14" fill="{% if forloop.counter <= 3 %}var(--warning){% else %}var(--gray-300){% endif %}" viewBox="0 0 24 24">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                  </svg>
                {% endfor %}
              {% endif %}
            </div>
          </div>
          
          <!-- Availability/Status -->
          <div style="margin-bottom: var(--spacing-md);">
            {% if listing.is_sold %}
              <span style="color: var(--error); font-size: var(--font-size-sm); font-weight: 600;">
                Sold out!
              </span>
            {% else %}
              <span style="color: var(--success); font-size: var(--font-size-sm); font-weight: 600;">
                Available!
              </span>
            {% endif %}
          </div>
          
          <!-- Price -->
          <div style="display: flex; align-items: baseline; justify-content: space-between; margin-bottom: var(--spacing-lg); padding-top: var(--spacing-md); border-top: 1px solid var(--gray-200);">
            <div>
              <div style="font-size: var(--font-size-2xl); font-weight: 700; color: var(--secondary); line-height: 1;">
                ₹{{ listing.price|floatformat:0 }}
              </div>
              {% if listing.is_certified %}
                <span class="badge badge-success" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs); display: inline-block;">
                  ✓ Certified
                </span>
              {% endif %}
            </div>
          </div>
          
          <!-- View Details Button -->
          <a href="{% url 'marketplace:detail' listing.pk %}" 
             class="btn btn-primary btn-full" 
             style="text-decoration: none; text-align: center; display: block;">
            View Details
          </a>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div style="grid-column: 1 / -1;">
      <div class="card text-center" style="padding: var(--spacing-3xl);">
        <p style="font-size: var(--font-size-lg); color: var(--gray-600); margin-bottom: var(--spacing-sm);">
          No devices available at the moment.
        </p>
        <p style="color: var(--gray-500);">Check back later for new listings.</p>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('filters');
  const resultsContainer = document.getElementById('listing-results');
  const loadingIndicator = document.getElementById('loading-indicator');
  const errorMessage = document.getElementById('error-message');
  
  if (!form || !resultsContainer) return;
  
  function showLoading() {
    loadingIndicator.style.display = 'block';
    errorMessage.style.display = 'none';
    resultsContainer.style.opacity = '0.5';
  }
  
  function hideLoading() {
    loadingIndicator.style.display = 'none';
    resultsContainer.style.opacity = '1';
  }
  
  function showError() {
    loadingIndicator.style.display = 'none';
    errorMessage.style.display = 'block';
    resultsContainer.style.opacity = '1';
  }
  
  function runFilters() {
    if (!navigator.onLine) {
      showError();
      return;
    }
    
    showLoading();
    const params = new URLSearchParams(new FormData(form));
    
    fetch(`{% url 'marketplace:listings_api' %}?${params.toString()}`)
      .then(r => {
        if (!r.ok) throw new Error('Network error');
        return r.json();
      })
      .then(data => {
        hideLoading();
        resultsContainer.innerHTML = '';
        
        if (!data.results || data.results.length === 0) {
          resultsContainer.innerHTML = `
            <div style="grid-column: 1 / -1;">
              <div class="card text-center" style="padding: var(--spacing-3xl);">
                <p style="font-size: var(--font-size-lg); color: var(--gray-600); margin-bottom: var(--spacing-md);">
                  No devices match your filters.
                </p>
                <button onclick="document.getElementById('filters').reset(); runFilters();" class="btn btn-outline">
                  Clear Filters
                </button>
              </div>
            </div>
          `;
          return;
        }
        
        data.results.forEach(item => {
          const card = document.createElement('div');
          card.className = 'card';
          card.style.cssText = 'padding: 0; overflow: hidden; position: relative; transition: all 0.3s ease;';
          
          const isSold = item.sold || false;
          const isCertified = item.certified || false;
          const ratingStars = isCertified ? 4 : 3;
          
          card.innerHTML = `
            <div style="position: relative; width: 100%; height: 240px; overflow: hidden; background: var(--gray-100);">
              <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--gray-400); background: var(--gray-100);">
                <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                </svg>
              </div>
              <div style="position: absolute; bottom: 12px; right: 12px; width: 40px; height: 40px; background: var(--error); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);"
                   onclick="window.location.href='/marketplace/${item.id}/'">
                <svg width="20" height="20" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.222M7.5 14.25l13.5-5.25M5.106 5.222L12.75 12.75m-7.644-7.5L12.75 12.75" />
                </svg>
              </div>
            </div>
            <div style="padding: var(--spacing-lg);">
              <h3 style="font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--spacing-sm); color: var(--gray-900);">${escapeHtml(item.title)}</h3>
              <div style="margin-bottom: var(--spacing-md);">
                <span class="badge badge-primary" style="font-size: var(--font-size-xs); text-transform: uppercase;">${escapeHtml(item.category)}</span>
              </div>
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--spacing-sm);">
                <div style="display: flex; gap: 2px;">
                  ${Array.from({length: 5}, (_, i) => `
                    <svg width="14" height="14" fill="${i < ratingStars ? 'var(--error)' : 'var(--gray-300)'}" viewBox="0 0 24 24">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                  `).join('')}
                </div>
              </div>
              <div style="margin-bottom: var(--spacing-md);">
                <span style="color: ${isSold ? 'var(--error)' : 'var(--success)'}; font-size: var(--font-size-sm); font-weight: 600;">
                  ${isSold ? 'Sold out!' : 'Available!'}
                </span>
              </div>
              <div style="display: flex; align-items: baseline; justify-content: space-between; margin-bottom: var(--spacing-lg); padding-top: var(--spacing-md); border-top: 1px solid var(--gray-200);">
                <div>
                  <div style="font-size: var(--font-size-2xl); font-weight: 700; color: var(--secondary);">₹${parseFloat(item.price).toFixed(0)}</div>
                  ${isCertified ? '<span class="badge badge-success" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs); display: inline-block;">✓ Certified</span>' : ''}
                </div>
              </div>
              <a href="/marketplace/${item.id}/" class="btn btn-primary btn-full" style="text-decoration: none; text-align: center; display: block;">View Details</a>
            </div>
          `;
          resultsContainer.appendChild(card);
        });
      })
      .catch(err => {
        console.error('Filter error:', err);
        showError();
      });
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  form.addEventListener('change', runFilters);
  form.addEventListener('input', function(e) {
    if (e.target.type === 'number') {
      runFilters();
    }
  });
});
</script>
{% endblock %}
