{% extends "adminpanel/base.html" %}
{% block admin_content %}
<div>
  <!-- Back Navigation -->
  <div style="margin-bottom: var(--spacing-xl);">
    <a href="{% url 'adminpanel:device_management' %}" class="btn btn-secondary" style="display: inline-flex; align-items: center; gap: 0.5rem;">
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
      Back to Device Management
    </a>
  </div>

  <!-- Header -->
  <div style="margin-bottom: var(--spacing-2xl);">
    <h1 style="margin-bottom: var(--spacing-sm);">Assign Repair Center</h1>
    <p style="color: var(--gray-600);">Assign this device to a repair partner for inspection and repair</p>
  </div>

  <!-- Device Information Card -->
  <div class="card" style="margin-bottom: var(--spacing-xl);">
    <h2 style="font-size: var(--font-size-xl); font-weight: 600; color: var(--gray-900); margin-bottom: var(--spacing-lg);">
      Device Information
    </h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-lg);">
      <div>
        <div style="font-size: var(--font-size-sm); font-weight: 500; color: var(--gray-600); margin-bottom: var(--spacing-xs);">Device Name</div>
        <div style="font-size: var(--font-size-base); color: var(--gray-900); font-weight: 500;">
          {{ device.title }}
        </div>
      </div>
      <div>
        <div style="font-size: var(--font-size-sm); font-weight: 500; color: var(--gray-600); margin-bottom: var(--spacing-xs);">Listing ID</div>
        <div style="font-size: var(--font-size-base); color: var(--gray-900); font-weight: 500; font-family: monospace;">
          {{ device.listing_id }}
        </div>
      </div>
      <div>
        <div style="font-size: var(--font-size-sm); font-weight: 500; color: var(--gray-600); margin-bottom: var(--spacing-xs);">Category</div>
        <div style="font-size: var(--font-size-base); color: var(--gray-900); font-weight: 500;">
          {{ device.get_category_display }}
        </div>
      </div>
      <div>
        <div style="font-size: var(--font-size-sm); font-weight: 500; color: var(--gray-600); margin-bottom: var(--spacing-xs);">Current Status</div>
        <div>
          <span class="badge {% if device.status == 'certified' or device.status == 'listed' %}badge-success{% elif device.status == 'submitted' or device.status == 'picked_up' %}badge-warning{% else %}badge-secondary{% endif %}">
            {{ device.get_status_display }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Current Assignment Alert -->
  {% if existing_assignment %}
    <div class="card card-primary" style="margin-bottom: var(--spacing-xl); border-left: 4px solid var(--primary);">
      <div style="display: flex; align-items: center; gap: var(--spacing-md);">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="color: var(--primary); flex-shrink: 0;">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div style="flex: 1;">
          <div style="font-size: var(--font-size-sm); font-weight: 600; color: var(--primary); margin-bottom: var(--spacing-xs); text-transform: uppercase; letter-spacing: 0.5px;">
            Currently Assigned
          </div>
          <div style="font-size: var(--font-size-base); color: var(--gray-900); font-weight: 500; margin-bottom: var(--spacing-xs);">
            {{ existing_assignment.repair_partner.get_full_name|default:existing_assignment.repair_partner.username }}
          </div>
          <div style="font-size: var(--font-size-sm); color: var(--gray-600);">
            Status: <span class="badge badge-primary" style="margin-left: var(--spacing-xs);">{{ existing_assignment.get_status_display }}</span>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Assignment Form -->
  <div class="card">
    <h2 style="font-size: var(--font-size-xl); font-weight: 600; color: var(--gray-900); margin-bottom: var(--spacing-lg);">
      Select Repair Partner
    </h2>
    
    <form method="post" style="display: flex; flex-direction: column; gap: var(--spacing-xl);">
      {% csrf_token %}
      
      <div class="form-group" style="margin-bottom: 0;">
        <label for="repair_partner" class="form-label">Repair Partner</label>
        {% if repair_partners %}
          <select name="repair_partner" id="repair_partner" class="form-control" required>
            <option value="">-- Select Repair Partner --</option>
            {% for partner in repair_partners %}
              <option value="{{ partner.id }}" {% if existing_assignment and existing_assignment.repair_partner.id == partner.id %}selected{% endif %}>
                {{ partner.get_full_name|default:partner.username }} - {{ partner.email }}
              </option>
            {% endfor %}
          </select>
          <p style="font-size: var(--font-size-xs); color: var(--gray-500); margin-top: var(--spacing-xs);">
            Select a repair partner to assign this device for inspection and repair
          </p>
        {% else %}
          <div style="background-color: var(--warning-bg); padding: var(--spacing-lg); border-radius: var(--radius-md); border-left: 4px solid var(--warning);">
            <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="color: var(--warning);">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <span style="font-weight: 600; color: var(--gray-900);">No Repair Partners Available</span>
            </div>
            <p style="font-size: var(--font-size-sm); color: var(--gray-700); margin: 0;">
              Create users with "Repair Partner" role first before assigning devices.
            </p>
          </div>
        {% endif %}
      </div>

      <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap; padding-top: var(--spacing-lg); border-top: 1px solid var(--gray-200);">
        <button type="submit" class="btn btn-primary" {% if not repair_partners %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="margin-right: var(--spacing-xs);">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Assign Partner
        </button>
        <a href="{% url 'adminpanel:device_management' %}" class="btn btn-secondary">
          Cancel
        </a>
      </div>
    </form>
  </div>

  <!-- Repair Partners List (if available) -->
  {% if repair_partners %}
    <div class="card" style="margin-top: var(--spacing-xl);">
      <h3 style="font-size: var(--font-size-lg); font-weight: 600; color: var(--gray-900); margin-bottom: var(--spacing-lg);">
        Available Repair Partners
      </h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: var(--spacing-md);">
        {% for partner in repair_partners %}
          <div style="background: var(--gray-50); padding: var(--spacing-md); border-radius: var(--radius-md); border: 1px solid var(--gray-200); transition: all 0.2s ease;" 
               onmouseover="this.style.borderColor='var(--primary)'; this.style.boxShadow='var(--shadow-md)'"
               onmouseout="this.style.borderColor='var(--gray-200)'; this.style.boxShadow='none'">
            <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="color: var(--primary);">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              <div style="font-weight: 600; color: var(--gray-900);">
                {{ partner.get_full_name|default:partner.username }}
              </div>
            </div>
            <div style="font-size: var(--font-size-sm); color: var(--gray-600); margin-bottom: var(--spacing-xs);">
              {{ partner.email }}
            </div>
            <div style="font-size: var(--font-size-xs); color: var(--gray-500);">
              Phone: {{ partner.phone_number }}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
